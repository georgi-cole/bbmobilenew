# Big Brother AI Responder – Express Server

This directory contains the Express backend that powers the Big Brother AI Diary Room responses.

## Prerequisites

- Node.js >= 18
- An OpenAI API key (for live LLM responses; the server works without one using deterministic fallbacks)

## Setup

```bash
cd server
npm install

# Copy the example env file and fill in your API key
cp .env.example .env
# Edit .env and set OPENAI_API_KEY
```

## Running

```bash
# Development (auto-restarts on file changes)
npm run dev

# Production
npm start
```

The server starts on port **4000** by default (configurable via `PORT` in `.env`).

## Environment variables

| Variable | Default | Description |
|---|---|---|
| `OPENAI_API_KEY` | *(empty)* | OpenAI API key. Without this, the server returns deterministic fallback replies and skips moderation. |
| `OPENAI_MODEL` | `gpt-4o-mini` | OpenAI chat completion model. |
| `PORT` | `4000` | Port the Express server listens on. |
| `RATE_LIMIT_WINDOW_MS` | `60000` | Rate-limit window in milliseconds (1 minute). |
| `RATE_LIMIT_MAX_REQUESTS` | `30` | Max requests per window per IP on `/api/*`. |

## API endpoints

### `POST /api/ai/bigbrother`

Accepts a JSON body:

```json
{
  "diaryText": "I really want to win the HOH this week.",
  "playerName": "Alex",
  "phase": "hoh_comp",
  "seed": 42
}
```

Returns:

```json
{
  "text": "Big Brother watches every move, Alex. Victory demands focus.",
  "reason": "llm"
}
```

`reason` is one of:
- `"llm"` – response generated by OpenAI
- `"fallback"` – LLM unavailable; deterministic canned reply chosen via `seed` + `diaryText`
- `"input_moderation"` – user input blocked by OpenAI moderation; canned refusal returned
- `"output_moderation"` – LLM output blocked by OpenAI moderation; canned refusal returned

### `GET /api/health`

Returns `{ "ok": true }`. Use to confirm the server is running.

## Running with the front-end

The Vite dev server proxies `/api` requests to `http://localhost:4000`. Start both:

```bash
# Terminal 1 – Express server
cd server && npm run dev

# Terminal 2 – Vite front-end
npm run dev
```

## Security notes

- **Never** commit your `.env` file or expose `OPENAI_API_KEY` to the browser.
- In production, use HTTPS and tighten rate-limit values.
- Consider adding authentication (e.g., a shared secret header) to restrict access to the endpoint.
